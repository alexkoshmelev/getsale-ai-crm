// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organizations & Users
model Organization {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  settings      Json     @default("{}")
  billingEmail  String?  @map("billing_email")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  members       OrganizationMember[]
  companies     Company[]
  contacts      Contact[]
  pipelines     Pipeline[]
  deals         Deal[]
  chats         Chat[]
  campaigns     Campaign[]
  aiAgents      AiAgent[]
  integrations  Integration[]
  webhooks      Webhook[]
  subscriptions Subscription[]
  events        Event[]
  auditLogs     AuditLog[]

  @@map("organizations")
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  passwordHash String? @map("password_hash")
  name        String?
  avatarUrl   String?  @map("avatar_url")
  mfaEnabled  Boolean  @default(false) @map("mfa_enabled")
  mfaSecret  String?  @map("mfa_secret")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  organizationMembers OrganizationMember[]
  oauthConnections    OAuthConnection[]
  auditLogs           AuditLog[]

  @@map("users")
}

model OrganizationMember {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  role           String   // owner, admin, bidi, viewer
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

model OAuthConnection {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  provider        String   // google, telegram
  providerUserId  String   @map("provider_user_id")
  accessToken     String?  @map("access_token") @db.Text
  refreshToken    String?  @map("refresh_token") @db.Text
  expiresAt       DateTime? @map("expires_at")
  createdAt       DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@map("oauth_connections")
}

// CRM Core
model Company {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  name          String
  industry      String?
  description   String?  @db.Text
  size          String?  // startup, small, medium, large, enterprise
  stage         String?  // lead, prospect, customer, partner
  website       String?
  logoUrl       String?  @map("logo_url")
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts     Contact[]
  deals        Deal[]

  @@map("companies")
}

model Contact {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  companyId       String?  @map("company_id")
  firstName       String?  @map("first_name")
  lastName        String?  @map("last_name")
  role            String?
  email           String?
  phone           String?
  telegramUsername String? @map("telegram_username")
  telegramChatId  BigInt?  @map("telegram_chat_id")
  linkedinUrl     String?  @map("linkedin_url") @db.Text
  whatsappPhone   String?  @map("whatsapp_phone")
  tags            String[]
  notes           String?  @db.Text
  source          String?  // manual, import, integration
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  company      Company?     @relation(fields: [companyId], references: [id], onDelete: SetNull)
  chats        Chat[]
  deals        Deal[]
  agentMemories AgentMemory[]

  @@map("contacts")
}

// Pipelines
model Pipeline {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  name          String
  description   String?  @db.Text
  isDefault     Boolean  @default(false) @map("is_default")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stages       PipelineStage[]
  deals        Deal[]

  @@map("pipelines")
}

model PipelineStage {
  id         String   @id @default(uuid())
  pipelineId String   @map("pipeline_id")
  name       String
  orderIndex Int      @map("order_index")
  color      String?
  createdAt  DateTime @default(now()) @map("created_at")

  pipeline Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  deals    Deal[]

  @@unique([pipelineId, orderIndex])
  @@map("pipeline_stages")
}

model Deal {
  id               String   @id @default(uuid())
  organizationId   String   @map("organization_id")
  pipelineId       String   @map("pipeline_id")
  stageId          String?  @map("stage_id")
  contactId        String?  @map("contact_id")
  companyId        String?  @map("company_id")
  name             String
  value            Decimal? @db.Decimal(12, 2)
  currency         String   @default("USD")
  expectedCloseDate DateTime? @map("expected_close_date")
  probability      Int      @default(0) // 0-100
  notes            String?  @db.Text
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  pipeline     Pipeline        @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  stage        PipelineStage?  @relation(fields: [stageId], references: [id], onDelete: SetNull)
  contact      Contact?        @relation(fields: [contactId], references: [id], onDelete: SetNull)
  company      Company?        @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@map("deals")
}

// Chats & Messages
model Chat {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  contactId       String   @map("contact_id")
  channel         String   // telegram, email, linkedin, whatsapp
  channelThreadId String?  @map("channel_thread_id")
  title           String?
  isUnread        Boolean  @default(true) @map("is_unread")
  lastMessageAt   DateTime? @map("last_message_at")
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact      Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  messages     Message[]

  @@unique([organizationId, contactId, channel, channelThreadId])
  @@map("chats")
}

model Message {
  id          String   @id @default(uuid())
  chatId      String   @map("chat_id")
  organizationId String @map("organization_id")
  senderType  String   @map("sender_type") // user, contact, ai_agent
  senderId    String?  @map("sender_id")
  content     String   @db.Text
  isIncoming  Boolean  @map("is_incoming")
  isRead      Boolean  @default(false) @map("is_read")
  aiDraft     Boolean  @default(false) @map("ai_draft")
  aiAgentId   String?  @map("ai_agent_id")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  chat    Chat            @relation(fields: [chatId], references: [id], onDelete: Cascade)
  agent   AiAgent?        @relation(fields: [aiAgentId], references: [id], onDelete: SetNull)
  attachments MessageAttachment[]

  @@map("messages")
}

model MessageAttachment {
  id        String   @id @default(uuid())
  messageId String   @map("message_id")
  fileUrl   String   @map("file_url") @db.Text
  fileName  String?  @map("file_name")
  fileType  String?  @map("file_type")
  fileSize  Int?     @map("file_size")
  createdAt DateTime @default(now()) @map("created_at")

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@map("message_attachments")
}

// AI Agents
model AiAgent {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  name          String
  type          String   // bizdev, sdr, followup, analytics, admin
  description   String?  @db.Text
  promptTemplate String  @map("prompt_template") @db.Text
  model         String   @default("gpt-4")
  temperature   Decimal  @default(0.7) @db.Decimal(3, 2)
  maxTokens     Int      @default(2000) @map("max_tokens")
  tools         String[]
  guardrails    Json     @default("{}")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages     Message[]
  memories     AgentMemory[]
  executions   AgentExecution[]

  @@map("ai_agents")
}

model AgentMemory {
  id            String   @id @default(uuid())
  agentId       String   @map("agent_id")
  organizationId String  @map("organization_id")
  contactId     String?  @map("contact_id")
  memoryType    String?  @map("memory_type") // fact, preference, context
  content       String   @db.Text
  embedding     Unsupported("vector(1536)")?
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at")

  agent   AiAgent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("agent_memories")
}

model AgentExecution {
  id             String   @id @default(uuid())
  agentId        String   @map("agent_id")
  organizationId String   @map("organization_id")
  triggerEvent   String?  @map("trigger_event")
  inputData      Json     @map("input_data")
  outputData     Json?    @map("output_data")
  status         String   // success, error, blocked
  errorMessage   String?  @map("error_message") @db.Text
  tokensUsed     Int?     @map("tokens_used")
  executionTimeMs Int?    @map("execution_time_ms")
  createdAt      DateTime @default(now()) @map("created_at")

  agent AiAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("agent_executions")
}

// Campaigns
model Campaign {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  name          String
  description   String?  @db.Text
  status        String   @default("draft") // draft, active, paused, completed
  targetAudience Json    @map("target_audience")
  messageTemplate String @map("message_template") @db.Text
  triggerType   String   @map("trigger_type") // manual, scheduled, event
  triggerConfig Json?    @map("trigger_config")
  startDate     DateTime? @map("start_date")
  endDate       DateTime? @map("end_date")
  createdBy     String?  @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages     CampaignMessage[]

  @@map("campaigns")
}

model CampaignMessage {
  id          String    @id @default(uuid())
  campaignId  String    @map("campaign_id")
  contactId   String    @map("contact_id")
  messageId   String?   @map("message_id")
  status      String    // pending, sent, delivered, replied, failed
  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  repliedAt   DateTime? @map("replied_at")
  errorMessage String?  @map("error_message") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact  Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("campaign_messages")
}

// Billing
model Subscription {
  id                   String    @id @default(uuid())
  organizationId       String    @map("organization_id")
  plan                 String    // free, pro, team, enterprise
  status               String    @default("active") // active, canceled, past_due
  billingCycle         String    @default("monthly") @map("billing_cycle") // monthly, yearly
  currentPeriodStart   DateTime  @map("current_period_start")
  currentPeriodEnd     DateTime  @map("current_period_end")
  cancelAtPeriodEnd    Boolean   @default(false) @map("cancel_at_period_end")
  stripeSubscriptionId String?   @map("stripe_subscription_id")
  stripeCustomerId     String?   @map("stripe_customer_id")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices     Invoice[]

  @@map("subscriptions")
}

model UsageLog {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  userId        String?  @map("user_id")
  metricType    String   @map("metric_type") // messages_sent, ai_calls, storage_gb
  quantity      Int
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("usage_logs")
}

model Invoice {
  id             String    @id @default(uuid())
  organizationId String    @map("organization_id")
  subscriptionId String?   @map("subscription_id")
  amount         Decimal   @db.Decimal(10, 2)
  currency       String    @default("USD")
  status         String    @default("pending") // pending, paid, failed
  stripeInvoiceId String?  @map("stripe_invoice_id")
  paidAt         DateTime? @map("paid_at")
  dueDate        DateTime? @map("due_date")
  createdAt      DateTime  @default(now()) @map("created_at")

  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@map("invoices")
}

// Integrations
model Integration {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  type          String   // hubspot, salesforce, telegram, email
  name          String?
  config        Json     // encrypted credentials
  isActive      Boolean  @default(true) @map("is_active")
  lastSyncAt    DateTime? @map("last_sync_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("integrations")
}

model Webhook {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  url           String   @db.Text
  events        String[]
  secret        String?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries   WebhookDelivery[]

  @@map("webhooks")
}

model WebhookDelivery {
  id            String   @id @default(uuid())
  webhookId     String   @map("webhook_id")
  eventType     String   @map("event_type")
  payload       Json
  status        String   // pending, success, failed
  responseStatus Int?    @map("response_status")
  responseBody  String?  @map("response_body") @db.Text
  attempts      Int      @default(0)
  nextRetryAt   DateTime? @map("next_retry_at")
  createdAt     DateTime @default(now()) @map("created_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@map("webhook_deliveries")
}

// Events & Audit
model Event {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  eventType     String   @map("event_type")
  entityType    String?  @map("entity_type")
  entityId      String?  @map("entity_id")
  userId        String?  @map("user_id")
  agentId       String?  @map("agent_id")
  payload       Json
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("events")
}

model AuditLog {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  userId        String?  @map("user_id")
  action        String
  resourceType  String?  @map("resource_type")
  resourceId    String?  @map("resource_id")
  changes       Json?
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

